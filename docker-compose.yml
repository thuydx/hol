services:
  # =========================
  # MYSQL DATABASE
  # =========================
  mysql:
    image: ${MYSQL_IMAGE}
    container_name: MySQL8
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - ${MYSQL_DATA_PATH}:/var/lib/mysql
      - ./configs/mysql/my.cnf:/etc/mysql/my.cnf
      - ./configs/mysql/docker.cnf:/etc/mysql/conf.d/docker.cnf
      - ./data/logs/mysql:/var/log/mysql
    networks:
      - workload
    restart: unless-stopped
    command: ["mysqld", "--user=mysql"]

  # =========================
  # NGINX + PHP-FPM + REDIS + SUPERVISOR
  # =========================
  nginx:
    image: ${NGINX_IMAGE}
    container_name: Nginx
    depends_on:
      - mysql
    environment:
      PHP_MEMORY_LIMIT: 512M
      APP_ENV: ${APP_ENV}
      APP_DEBUG: ${APP_DEBUG}
      APP_URL: ${APP_URL}
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${MYSQL_DATABASE}
      DB_USERNAME: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      # ✅ Laravel source
      - ${BACKEND_PATH}:/var/www/html:delegated

      # ✅ Nginx configuration
      - ./configs/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./configs/nginx/conf.d:/etc/nginx/conf.d:ro

      # ✅ Correct PHP-FPM configuration overrides
      - ./configs/php/conf.d/app-fpm.ini:/etc/php/${PHP_VERSION}/fpm/conf.d/app-fpm.ini:ro
      - ./configs/php/conf.d/app-xdebug.ini:/etc/php/${PHP_VERSION}/fpm/conf.d/app-xdebug.ini:ro
      - ./configs/php/php-fpm.d/www.conf:/etc/php/${PHP_VERSION}/fpm/pool.d/www.conf:ro

      # ✅ Supervisor configs
      - ./configs/supervisor/supervisord.conf:/etc/supervisor/supervisord.conf:ro
      - ./configs/supervisor/conf.d:/etc/supervisor/conf.d:ro

      # ✅ Redis config, data, and logs
      - ./configs/redis/redis.conf:/etc/redis/redis.conf:ro
      - ./data/redis:/var/lib/redis
      - ./data/logs/redis:/var/log/redis

      # ✅ Persistent logs
      - ./data/logs/nginx:/var/log/nginx
      - ${BACKEND_PATH}/storage/logs:/var/www/html/storage/logs

    ports:
      - "${BACKEND_PORT}:${BACKEND_PORT}"
    networks:
      - workload
    restart: unless-stopped

  # =========================
  # REVERSE PROXY
  # =========================
  nginx-proxy:
    image: ${PROXY_IMAGE}
    container_name: Reverse-Proxy
    depends_on:
      - nginx
    ports:
      - "${NGINX_PROXY_PORT}:80"
      - "${NGINX_SSL_PORT}:443"
    volumes:
      - ./configs/proxy/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./configs/proxy/nginx-proxy.conf:/etc/nginx/conf.d/nginx-proxy.conf:ro
      - ./configs/proxy/nginx.proxy.settings:/etc/nginx/nginx.proxy.settings:ro
      - ./configs/proxy/ssl:/etc/nginx/ssl:ro
      # ✅ Proxy logs
      - ./data/logs/nginx-proxy:/var/log/nginx
    environment:
      BACKEND_HOST: ${BACKEND_HOST}
      BACKEND_PORT: ${BACKEND_PORT}
    networks:
      - workload
    restart: unless-stopped

# =========================
# NETWORK
# =========================
networks:
  workload:
    driver: bridge
